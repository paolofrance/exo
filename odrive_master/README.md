# ODrive-Master

This folder contains the C++ ODrive-Master interface for the Low-Back Exoskeleton. Documentation for the code is automatically generated by Doxygen in the folder `doc` with the command `make doc`, and automatically updated (if necessary).

## ODrive

The motor controller used for this exoskeleton is [ODrive v3.6](https://docs.odriverobotics.com/v/0.5.4/getting-started.html) by ODrive Robotics. It is a dual-axis motor driver and controller with a USB interface. 
ODrive features a 8 kHz control loop with tunable torque, velocity and position controllers. The current controller is automatically tuned during setup and does not require additional tuning.
The code written here is the higher-level control system that sends torque/velocity/position setpoints and can read feedback data from the motors and the encoders.

ODrive provides a basic Python interface for interacting and controlling with the motor controller. `odrivetool` can be installed following the documentation on their website at this [link](vhttps://docs.odriverobotics.com/v/0.5.4/getting-started.html).
**NOTE**: do not use `odrivetool` to implement the high-level control system, as it may be unable to work at a sufficiently high frequency (i.e., 1000 Hz). `odrivetool` should be used for debugging/troubleshooting, also exploiting its [liveplotter](https://docs.odriverobotics.com/v/0.5.4/odrivetool.html?highlight=liveplotter#liveplotter) functionality for live plots of any variable.

## Build instructions and dependencies

This project has few external dependencies, such as make, Doxygen and Boost. If necessary, install them with:

    sudo apt install -y build-essentials doxygen doxygen-gui libboost1.65-all-dev

To build the project, we can use `cmake` and `make`:

    mkdir build && cd build/
    cmake ..
    make -j8

This will create the executable file `odrive_master` in the main folder (i.e., `./`) -- and not in `./build` -- and the documentation in `./doc`. To read the documentation, just open (double-click) the file `./doc/index.html` with a browser (e.g., Chrome or Firefox) and navigate to the classes `ODrive` and `ODrive_base`.

## Running 

To run the code, we can simply run the executable in a terminal `odrive_master` with admin privileges:

    cd build
    make -j8 && sudo ../odrive_master [--debug]

There are some optional parameters that we can specify via the command line:

- `--debug`: enable DEBUG mode: file logging defaults to `debug.csv` and logging to console is increased;
- `--disable-watchdog`: enable ODrive's watchdog timers; WARNING: this is a safety feature that should always be enabled!
- `--help` or `-h`: shows a help message;
- `--reboot`: reboot ODrive during the init;
- `--filename` or `-f`: specify a filename for logging to file (e.g., `my_test.csv`); if nothing is specified, ODrive-Master automatically creates a filename with a timestamp to prevent overwriting;
- `--master-mode`: standalone mode with shared memory disabled; no higher-level control system is expected to be active at the same time;
- `--port` or `-P`: specify a custom serial port for the USB connection (default: `/dev/ttyACM0`);
- `--verbose VERBOSITY_LEVEL` or `-v VERBOSITY_LEVEL`: specify a verbosity level for console logging, default is 2 (i.e., `LOG_INFO`); verbosity levels can be found in `./include/logging.h`; example: `sudo ./odrive_master -v 0` 
- `--version` or `-V`: prints the version of the code and exits;

### Note on file logging

Since the code is runned with `sudo`, the logfiles have read-only access for the user (they are owned by `root`). By default, logfiles are stored in `build` (in general, in the folder from which `odrive_master` is called). To gain write permission on the logfiles, we can do `sudo chown $USER *.csv`.